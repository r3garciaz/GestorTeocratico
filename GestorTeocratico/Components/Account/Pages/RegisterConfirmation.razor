@page "/Account/RegisterConfirmation"

@using System.Text
@using Microsoft.AspNetCore.WebUtilities

@inject UserManager<ApplicationUser> UserManager
@inject IEmailSender<ApplicationUser> EmailSender
@inject NavigationManager NavigationManager
@inject IdentityRedirectManager RedirectManager

<PageTitle>Register confirmation</PageTitle>

<RadzenCard class="rz-my-12 rz-mx-auto rz-p-4 rz-p-md-12 rz-border-radius-4" style="max-width: 600px;">
    <RadzenText TextStyle="TextStyle.DisplayH4" Text="Confirmación de registro" TextAlign="TextAlign.Center"
                class="rz-color-primary rz-mb-4"/>
    <div class="rz-text-align-center">
        @if (!string.IsNullOrEmpty(_statusMessage))
        {
            <div class="account-msg-error rz-mb-4">
                @_statusMessage
            </div>
        }
        @if (_emailConfirmationLink is not null)
        {
            <div class="account-msg-info rz-mb-4">
                <RadzenAlert AlertStyle="AlertStyle.Info" class="rz-mb-3">
                    <RadzenText TextStyle="TextStyle.Body1">
                        <strong>No hay proveedor de email:</strong> El email no se envió automáticamente.
                    </RadzenText>
                </RadzenAlert>
                <RadzenText TextStyle="TextStyle.Body1" class="rz-mb-3">
                    En un entorno de producción, este enlace se enviaría por email:
                </RadzenText>
                <RadzenLink Path="@_emailConfirmationLink">
                <RadzenButton Text="Confirmar cuenta ahora" 
                              ButtonStyle="ButtonStyle.Primary" 
                              Size="ButtonSize.Large"
                              class="rz-border-radius-2" />
                </RadzenLink>
            </div>
        }
        else
        {
            <RadzenAlert AlertStyle="AlertStyle.Success" class="rz-mb-4">
                <RadzenText TextStyle="TextStyle.H6" class="rz-mb-2">
                    ¡Email enviado correctamente! 📧
                </RadzenText>
                <RadzenText TextStyle="TextStyle.Body1">
                    Revisa tu bandeja de entrada y haz clic en el enlace de confirmación para activar tu cuenta.
                </RadzenText>
            </RadzenAlert>
            
            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-base-600 rz-mb-3">
                Si no ves el email, revisa también tu carpeta de spam o correo no deseado.
            </RadzenText>
            
            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.Center" Gap="1rem">
                <RadzenLink Path="/">
                    <RadzenButton Text="Volver al inicio" 
                                  ButtonStyle="ButtonStyle.Light" 
                                  class="rz-border-radius-2" />
                </RadzenLink>
                <RadzenLink Path="/Account/Login">
                    <RadzenButton Text="Ir al login" 
                                  ButtonStyle="ButtonStyle.Secondary" 
                                  class="rz-border-radius-2" />
                </RadzenLink>
            </RadzenStack>
        }
    </div>
</RadzenCard>

@code {
    private string? _emailConfirmationLink;
    private string? _statusMessage;

    [CascadingParameter] private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromQuery] private string? Email { get; set; }

    [SupplyParameterFromQuery] private string? ReturnUrl { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (Email is null)
        {
            RedirectManager.RedirectTo("");
        }

        var user = await UserManager.FindByEmailAsync(Email);
        if (user is null)
        {
            HttpContext.Response.StatusCode = StatusCodes.Status404NotFound;
            _statusMessage = "Error finding user for unspecified email";
        }
        else if (EmailSender is Components.Account.IdentityNoOpEmailSender)
        {
            // Solo en desarrollo - genera el enlace de confirmación manualmente
            var userId = await UserManager.GetUserIdAsync(user);
            var code = await UserManager.GenerateEmailConfirmationTokenAsync(user);
            code = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));
            _emailConfirmationLink = NavigationManager.GetUriWithQueryParameters(
                NavigationManager.ToAbsoluteUri("Account/ConfirmEmail").AbsoluteUri,
                new Dictionary<string, object?> { ["userId"] = userId, ["code"] = code, ["returnUrl"] = ReturnUrl });
        }
        // Si llegamos aquí y _emailConfirmationLink es null, significa que se envió el email correctamente
    }
}