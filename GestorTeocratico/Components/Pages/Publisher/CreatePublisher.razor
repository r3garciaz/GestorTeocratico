@using GestorTeocratico.Entities
@using GestorTeocratico.Shared.Enums
@inject DialogService DialogService
@inject GestorTeocratico.Features.Publishers.IPublisherService PublisherService

<PageTitle>Agregar Publicador</PageTitle>
<RadzenColumn SizeMD=12>
    <RadzenAlert Shade="Shade.Lighter" Variant="Variant.Flat" Size="AlertSize.Small" AlertStyle="AlertStyle.Danger"
                 Visible="@_errorVisible">No se puede guardar el publicador
    </RadzenAlert>
    <RadzenTemplateForm TItem="Publisher" Data="@(_publisher)" Visible="@(_publisher != null)"
                        Submit="@HandleValidSubmit">
        <RadzenRow style="margin-bottom: 1rem">
            <RadzenColumn SizeMD="3">
                <RadzenLabel Text="Nombre" Component="FirstName" style="width: 100%"/>
            </RadzenColumn>
            <RadzenColumn SizeMD="9">
                <RadzenTextBox style="display: block; width: 100%" @bind-Value="@(_publisher.FirstName)" Name="FirstName"/>
                <RadzenRequiredValidator Component="FirstName" Text="El nombre es obligatorio"/>
            </RadzenColumn>
        </RadzenRow>
        <RadzenRow style="margin-bottom: 1rem">
            <RadzenColumn SizeMD="3">
                <RadzenLabel Text="Apellido" Component="LastName" style="width: 100%"/>
            </RadzenColumn>
            <RadzenColumn SizeMD="9">
                <RadzenTextBox style="display: block; width: 100%" @bind-Value="@(_publisher.LastName)" Name="LastName"/>
            </RadzenColumn>
        </RadzenRow>
        <RadzenRow style="margin-bottom: 1rem">
            <RadzenColumn SizeMD="3">
                <RadzenLabel Text="Apellido Materno" Component="MotherLastName" style="width: 100%"/>
            </RadzenColumn>
            <RadzenColumn SizeMD="9">
                <RadzenTextBox style="display: block; width: 100%" @bind-Value="@(_publisher.MotherLastName)" Name="MotherLastName"/>
            </RadzenColumn>
        </RadzenRow>
        <RadzenRow style="margin-bottom: 1rem">
            <RadzenColumn SizeMD="3">
                <RadzenLabel Text="Teléfono" Component="Phone" style="width: 100%"/>
            </RadzenColumn>
            <RadzenColumn SizeMD="9">
                <RadzenTextBox style="display: block; width: 100%" @bind-Value="@(_publisher.Phone)" Name="Phone"/>
            </RadzenColumn>
        </RadzenRow>
        <RadzenRow style="margin-bottom: 1rem">
            <RadzenColumn SizeMD="3">
                <RadzenLabel Text="Correo Electrónico" Component="Email" style="width: 100%"/>
            </RadzenColumn>
            <RadzenColumn SizeMD="9">
                <RadzenTextBox style="display: block; width: 100%" @bind-Value="@(_publisher.Email)" Name="Email"/>
            </RadzenColumn>
        </RadzenRow>
        <RadzenRow style="margin-bottom: 1rem">
            <RadzenColumn SizeMD="3">
                <RadzenLabel Text="Género" Component="Gender" style="width: 100%"/>
            </RadzenColumn>
            <RadzenColumn SizeMD="9">
                <RadzenDropDown @bind-Value="@_publisher.Gender" 
                                Data="@_genderOptions" 
                                TextProperty="@nameof(GenderOption.DisplayName)" 
                                ValueProperty="@nameof(GenderOption.Value)"
                                Placeholder="Selecciona género"
                                Style="width: 100%; max-width: 400px;" 
                                Name="Gender" />
                <RadzenRequiredValidator Component="Gender" Text="El género es obligatorio"/>
            </RadzenColumn>
        </RadzenRow>
        <RadzenRow style="margin-bottom: 1rem">
            <RadzenColumn SizeMD="3">
                <RadzenLabel Text="Privilegio" Component="Privilege" style="width: 100%"/>
            </RadzenColumn>
            <RadzenColumn SizeMD="9">
                <RadzenDropDown @bind-Value="@_publisher.Privilege" 
                                Data="@_privilegeOptions" 
                                TextProperty="@nameof(PrivilegeOption.DisplayName)" 
                                ValueProperty="@nameof(PrivilegeOption.Value)"
                                AllowClear="true"
                                Placeholder="Selecciona privilegio (opcional)"
                                Style="width: 100%; max-width: 400px;" 
                                Name="Privilege" />
            </RadzenColumn>
        </RadzenRow>
        <RadzenRow style="margin-bottom: 1rem">
            <RadzenColumn SizeMD="3">
                <RadzenLabel Text="Responsabilidades" Component="ResponsibilityIds" style="width: 100%"/>
            </RadzenColumn>
            <RadzenColumn SizeMD="9">
                <RadzenDropDown @bind-Value="@_selectedResponsibilityIds" 
                                Data="@_availableResponsibilities" 
                                TextProperty="@nameof(Responsibility.Name)" 
                                ValueProperty="@nameof(Responsibility.ResponsibilityId)"
                                Multiple="true"
                                AllowClear="true"
                                Placeholder="Selecciona responsabilidades (opcional)"
                                Style="width: 100%; max-width: 400px;" 
                                Name="ResponsibilityIds" />
            </RadzenColumn>
        </RadzenRow>
        <RadzenRow style="margin-bottom: 1rem">
            <RadzenColumn SizeMD="3">
                <RadzenLabel Text="Departamentos" Component="DepartmentIds" style="width: 100%"/>
            </RadzenColumn>
            <RadzenColumn SizeMD="9">
                <RadzenDropDown @bind-Value="@_selectedDepartmentIds" 
                                Data="@_availableDepartments" 
                                TextProperty="@nameof(Department.Name)" 
                                ValueProperty="@nameof(Department.DepartmentId)"
                                Multiple="true"
                                AllowClear="true"
                                Placeholder="Selecciona departamentos (opcional)"
                                Style="width: 100%; max-width: 400px;" 
                                Name="DepartmentIds" />
            </RadzenColumn>
        </RadzenRow>
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center"
                     JustifyContent="JustifyContent.End" Gap="0.5rem">
            <RadzenButton ButtonStyle="ButtonStyle.Primary" ButtonType="ButtonType.Submit" Icon="save" Text="Guardar"
                          Variant="Variant.Flat"/>
            <RadzenButton ButtonStyle="ButtonStyle.Light" Text="Cancelar" Variant="Variant.Flat"
                          Click="@CancelButtonClick"/>
        </RadzenStack>
    </RadzenTemplateForm>
</RadzenColumn>

@code {
    private readonly Publisher _publisher = new() { FirstName = string.Empty, Gender = Gender.Male };
    private bool _errorVisible;
    private IEnumerable<Responsibility> _availableResponsibilities = [];
    private IEnumerable<Guid> _selectedResponsibilityIds = [];
    private IEnumerable<Department> _availableDepartments = [];
    private IEnumerable<Guid> _selectedDepartmentIds = [];
    private IEnumerable<GenderOption> _genderOptions = [];
    private IEnumerable<PrivilegeOption> _privilegeOptions = [];

    protected override async Task OnInitializedAsync()
    {
        await LoadAvailableResponsibilities();
        await LoadAvailableDepartments();
        LoadGenderOptions();
        LoadPrivilegeOptions();
    }

    private async Task LoadAvailableResponsibilities()
    {
        _availableResponsibilities = await PublisherService.GetAvailableResponsibilitiesAsync();
    }

    private async Task LoadAvailableDepartments()
    {
        _availableDepartments = await PublisherService.GetAvailableDepartmentsAsync();
    }

    private void LoadGenderOptions()
    {
        _genderOptions = Enum.GetValues<Gender>().Select(g => new GenderOption
        {
            Value = g,
            DisplayName = GetGenderDisplayName(g)
        });
    }

    private void LoadPrivilegeOptions()
    {
        _privilegeOptions = Enum.GetValues<Privilege>().Select(p => new PrivilegeOption
        {
            Value = p,
            DisplayName = GetPrivilegeDisplayName(p)
        });
    }

    private async Task HandleValidSubmit()
    {
        try
        {
            await PublisherService.AddAsync(_publisher);
            
            // Actualizar responsabilidades si se seleccionaron algunas
            if (_selectedResponsibilityIds.Any())
            {
                await PublisherService.UpdatePublisherResponsibilitiesAsync(_publisher.PublisherId, _selectedResponsibilityIds);
            }

            // Actualizar departamentos si se seleccionaron algunos
            if (_selectedDepartmentIds.Any())
            {
                await PublisherService.UpdatePublisherDepartmentsAsync(_publisher.PublisherId, _selectedDepartmentIds);
            }
            
            DialogService.Close(true);
        }
        catch
        {
            _errorVisible = true;
        }
    }

    private async Task CancelButtonClick(MouseEventArgs args)
    {
        DialogService.Close(null);
    }

    private string GetGenderDisplayName(Gender gender)
    {
        return gender switch
        {
            Gender.Male => "Masculino",
            Gender.Female => "Femenino",
            _ => gender.ToString()
        };
    }

    private string GetPrivilegeDisplayName(Privilege privilege)
    {
        return privilege switch
        {
            Privilege.Elder => "Anciano",
            Privilege.MinisterialServant => "Siervo Ministerial",
            Privilege.Pioneer => "Precursor",
            _ => privilege.ToString()
        };
    }

    public class GenderOption
    {
        public Gender Value { get; set; }
        public string DisplayName { get; set; } = string.Empty;
    }

    public class PrivilegeOption
    {
        public Privilege Value { get; set; }
        public string DisplayName { get; set; } = string.Empty;
    }
}
