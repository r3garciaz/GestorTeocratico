@page "/publishers"
@using GestorTeocratico.Entities
@using GestorTeocratico.Features.Publishers
@using GestorTeocratico.Shared.Enums
@inject IPublisherService PublisherService
@inject DialogService DialogService
@inject NotificationService NotificationService

<PageTitle>Publicadores</PageTitle>
<RadzenStack>
    <RadzenRow AlignItems="AlignItems.Center">
        <RadzenColumn Size="12" SizeMD="6">
            <RadzenText Text="Publicadores" TextStyle="TextStyle.H3" TagName="TagName.H1" style="margin: 0"/>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeMD="6">
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center"
                         JustifyContent="JustifyContent.End" Gap="0.5rem">
                <RadzenButton Icon="add_circle_outline" Text="Agregar Publicador" Click="@AddButtonClick" Variant="Variant.Flat"/>
            </RadzenStack>
        </RadzenColumn>
    </RadzenRow>
    <RadzenRow>
        <RadzenColumn SizeMD="12">
            <RadzenDataGrid @ref="grid0" ColumnWidth="200px" AllowFiltering="true" FilterMode="FilterMode.Advanced"
                            AllowPaging="true" AllowSorting="true" ShowPagingSummary="true"
                            PageSizeOptions=@(new int[] { 5, 10, 20, 30 })
                            Data="@(_publishers)" >
                <Columns>
                    <RadzenDataGridColumn Property="@nameof(Publisher.FirstName)" Title="Nombre"/>
                    <RadzenDataGridColumn Property="@nameof(Publisher.LastName)" Title="Apellido"/>
                    <RadzenDataGridColumn Property="@nameof(Publisher.Gender)" Title="Género">
                        <Template Context="publisher">
                            <span>@GetGenderDisplayName(publisher.Gender)</span>
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn Property="@nameof(Publisher.Privilege)" Title="Privilegio">
                        <Template Context="publisher">
                            @if (publisher.Privilege.HasValue)
                            {
                                <span>@GetPrivilegeDisplayName(publisher.Privilege.Value)</span>
                            }
                            else
                            {
                                <span class="text-muted">Sin privilegio</span>
                            }
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn Property="@nameof(Publisher.ResponsibleDepartments)" Title="Departamentos Responsables">
                        <Template Context="publisher">
                            @if (publisher.ResponsibleDepartments?.Any() == true)
                            {
                                <span>@string.Join(", ", publisher.ResponsibleDepartments.Take(2).Select(d => d.Name))</span>
                                @if (publisher.ResponsibleDepartments.Count > 2)
                                {
                                    <span class="text-muted"> y @(publisher.ResponsibleDepartments.Count - 2) más...</span>
                                }
                            }
                            else
                            {
                                <span class="text-muted">Sin departamentos</span>
                            }
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn Property="@nameof(Publisher.PublisherResponsibilities)" Title="Responsabilidades">
                        <Template Context="publisher">
                            @if (publisher.PublisherResponsibilities?.Any() == true)
                            {
                                <span>@string.Join(", ", publisher.PublisherResponsibilities.Take(2).Select(pr => pr.Responsibility.Name))</span>
                                @if (publisher.PublisherResponsibilities.Count > 2)
                                {
                                    <span class="text-muted"> y @(publisher.PublisherResponsibilities.Count - 2) más...</span>
                                }
                            }
                            else
                            {
                                <span class="text-muted">Sin responsabilidades</span>
                            }
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn Filterable="false" Sortable="false" Width="150px" Title="Acciones"
                                          TextAlign="TextAlign.Center">
                        <Template Context="publisher">
                            <RadzenButton Icon="article" ButtonStyle="ButtonStyle.Success" Variant="Variant.Outlined" Size="ButtonSize.Medium"
                                          Click="@(() => ShowDetailsModal(publisher))" @onabort:stopPropagation="true" />
                            <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat"
                                          Size="ButtonSize.Medium"
                                          Click="@(() => EditRow(publisher))" @onclick:stopPropagation="true"/>
                            <RadzenButton ButtonStyle="ButtonStyle.Danger" Icon="delete" Size="ButtonSize.Medium"
                                          Shade="Shade.Lighter" Variant="Variant.Flat"
                                          Click="@(args => GridDeleteButtonClick(args, publisher))"
                                          @onclick:stopPropagation="true"/>
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        </RadzenColumn>
    </RadzenRow>
</RadzenStack>

@code {
    private IEnumerable<Publisher> _publishers = [];
    private RadzenDataGrid<Publisher> grid0;

    protected override async Task OnInitializedAsync()
    {
        _publishers = await PublisherService.GetAllAsync();
    }

    private async Task AddButtonClick(MouseEventArgs args)
    {
        await DialogService.OpenAsync<CreatePublisher>("Agregar Publicador", null);
        await grid0.Reload();
    }

    private async Task EditRow(Publisher args)
    {
        await DialogService.OpenAsync<EditPublisher>("Editar Publicador", new Dictionary<string, object> { { "PublisherId", args.PublisherId } });
        await grid0.Reload();
    }

    private async Task GridDeleteButtonClick(MouseEventArgs args, Publisher publisher)
    {
        try
        {
            if (await DialogService.Confirm("¿Está seguro que desea eliminar este registro?", "Confirmar", new ConfirmOptions { OkButtonText = "Eliminar", CancelButtonText = "Cancelar" }) == true)
            {
                var deleteResult = await PublisherService.DeleteAsync(publisher.PublisherId);
                await grid0.Reload();
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = $"Error",
                Detail = $"No se pudo eliminar el publicador"
            });
        }
    }
    
    private async Task ShowDetailsModal(Publisher publisher)
    {
        var parameters = new Dictionary<string, object> { ["publisher"] = publisher };
        await DialogService.OpenAsync<DetailsPublisher>("Detalles del Publicador", parameters);
    }

    private string GetGenderDisplayName(Gender gender)
    {
        return gender switch
        {
            Gender.Male => "Masculino",
            Gender.Female => "Femenino",
            _ => gender.ToString()
        };
    }

    private string GetPrivilegeDisplayName(Privilege privilege)
    {
        return privilege switch
        {
            Privilege.Elder => "Anciano",
            Privilege.MinisterialServant => "Siervo Ministerial",
            Privilege.Pioneer => "Precursor",
            _ => privilege.ToString()
        };
    }
}
