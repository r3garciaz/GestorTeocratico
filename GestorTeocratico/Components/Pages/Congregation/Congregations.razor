@page "/congregations"
@using GestorTeocratico.Entities
@using GestorTeocratico.Features.Congregations
@inject ICongregationService CongregationService
@inject NotificationService NotificationService
@attribute [Authorize(Roles = "Admin, Manager")]

<PageTitle>Congregación</PageTitle>

<RadzenCard Style="min-width:400px; max-width:1000px; margin:auto; box-shadow: 0 4px 24px rgba(0,0,0,0.06); border-radius: 8px; padding: 1rem;">
     <RadzenColumn Size="12" SizeMD="6">
            <RadzenText Text="Congregación" TextStyle="TextStyle.H3" TagName="TagName.H1" style="margin: 0"/>
        </RadzenColumn>
    <RadzenTemplateForm TItem="Congregation" Data="@_congregation" Submit="@HandleValidSubmit">
        <RadzenRow Gap="2rem" class="rz-p-0 rz-p-lg-4">
            <RadzenColumn Size="12">
                <RadzenFieldset Text="Detalles de la Congregación">
                    <RadzenStack  Gap="1rem">
                    <RadzenRow>
                        <RadzenColumn Size="12" SizeMD="4">
                            <RadzenLabel Text="Nombre" Component="Name" style="width: 100%" />
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeMD="8">
                            <RadzenTextBox style="display: block; width: 100%" @bind-Value="@(_congregation.Name)" Name="Name" />
                            <RadzenRequiredValidator Component="Name" Text="El nombre es obligatorio" />
                        </RadzenColumn>
                    </RadzenRow>
                    <RadzenRow >
                        <RadzenColumn Size="12" SizeMD="4">
                            <RadzenLabel Text="Día Semana Año Par" Component="MidweekMeetingDayEvenYear" style="width: 100%" />
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeMD="8">
                            <RadzenDropDown @bind-Value="@_congregation.MidweekMeetingDayEvenYear" Data="@_daysOfWeek" Style="width: 100%; max-width: 400px;" Name="MidweekMeetingDayEvenYear" />
                        </RadzenColumn>
                    </RadzenRow>
                    <RadzenRow >
                        <RadzenColumn Size="12" SizeMD="4">
                            <RadzenLabel Text="Día Semana Año Impar" Component="MidweekMeetingDayOddYear" style="width: 100%" />
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeMD="8">
                            <RadzenDropDown @bind-Value="@_congregation.MidweekMeetingDayOddYear" Data="@_daysOfWeek" Style="width: 100%; max-width: 400px;" Name="MidweekMeetingDayOddYear" />
                        </RadzenColumn>
                    </RadzenRow>
                    <RadzenRow >
                        <RadzenColumn Size="12" SizeMD="4">
                            <RadzenLabel Text="Día Fin de Semana Año Par" Component="WeekendMeetingDayEvenYear" style="width: 100%" />
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeMD="8">
                            <RadzenDropDown @bind-Value="@_congregation.WeekendMeetingDayEvenYear" Data="@_daysOfWeek" Style="width: 100%; max-width: 400px;" Name="WeekendMeetingDayEvenYear" />
                        </RadzenColumn>
                    </RadzenRow>
                    <RadzenRow >
                        <RadzenColumn Size="12" SizeMD="4">
                            <RadzenLabel Text="Día Fin de Semana Año Impar" Component="WeekendMeetingDayOddYear" style="width: 100%" />
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeMD="8">
                            <RadzenDropDown @bind-Value="@_congregation.WeekendMeetingDayOddYear" Data="@_daysOfWeek" Style="width: 100%; max-width: 400px;" Name="WeekendMeetingDayOddYear" />
                        </RadzenColumn>
                    </RadzenRow>
                    <RadzenRow >
                        <RadzenColumn Size="12" SizeMD="4">
                            <RadzenLabel Text="Dirección" Component="Address" style="width: 100%" />
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeMD="8">
                            <RadzenTextBox style="display: block; width: 100%" @bind-Value="@(_congregation.Address)" Name="Address" />
                        </RadzenColumn>
                    </RadzenRow>
                    <RadzenRow >
                        <RadzenColumn Size="12" SizeMD="4">
                            <RadzenLabel Text="Ciudad" Component="City" style="width: 100%" />
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeMD="8">
                            <RadzenTextBox style="display: block; width: 100%" @bind-Value="@(_congregation.City)" Name="City" />
                        </RadzenColumn>
                    </RadzenRow>
                    </RadzenStack>
                </RadzenFieldset>
            </RadzenColumn>
        </RadzenRow>

         <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center"
                     JustifyContent="JustifyContent.End" Gap="0.5rem">
                <RadzenButton ButtonStyle="ButtonStyle.Primary" ButtonType="ButtonType.Submit" Icon="save" Text="Guardar" Variant="Variant.Filled" Style="min-width:120px;" />
                @* <RadzenButton ButtonStyle="ButtonStyle.Light" Text="Cancelar" Variant="Variant.Outlined" Click="@Cancel" Style="min-width:120px;" /> *@
        </RadzenStack>
    </RadzenTemplateForm>
</RadzenCard>

@code {
    private Congregation _congregation = new() { Name = string.Empty };
    private readonly List<DayOfWeek> _daysOfWeek = Enum.GetValues(typeof(DayOfWeek)).Cast<DayOfWeek>().ToList();
    private bool _isNew = false;

    protected override async Task OnInitializedAsync()
    {
        var items = await CongregationService.GetAllAsync();
        var first = items.FirstOrDefault();
        if (first == null)
        {
            _congregation = new Congregation { Name = string.Empty };
            _isNew = true;
        }
        else
        {
            _congregation = first;
            _isNew = false;
        }
    }

    private async Task HandleValidSubmit()
    {
        try
        {
            if (_isNew)
            {
                await CongregationService.AddAsync(_congregation);
                NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Creado", Detail = "Congregación creada." });
                _isNew = false;
            }
            else
            {
                await CongregationService.UpdateAsync(_congregation);
                NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Guardado", Detail = "Congregación actualizada." });
            }
        }
        catch (InvalidOperationException ex)
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Warning, Summary = "Atención", Detail = ex.Message });
        }
        catch (Exception)
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Error", Detail = "Ocurrió un error al guardar." });
        }
    }

    private async Task Cancel(MouseEventArgs args)
    {
        // reload current state from DB
        var items = await CongregationService.GetAllAsync();
        var first = items.FirstOrDefault();
        if (first == null)
        {
            _congregation = new Congregation { Name = string.Empty };
            _isNew = true;
        }
        else
        {
            _congregation = first;
            _isNew = false;
        }
        StateHasChanged();
    }
}
