@using GestorTeocratico.Entities
@inject DialogService DialogService
@inject GestorTeocratico.Features.Congregations.ICongregationService CongregationService
@inject NotificationService NotificationService

<PageTitle>Agregar Congregación</PageTitle>
<RadzenColumn SizeMD=12>
    <RadzenAlert Shade="Shade.Lighter" Variant="Variant.Flat" Size="AlertSize.Small" AlertStyle="AlertStyle.Danger"
                 Visible="@_errorVisible">No se puede guardar la congregación
    </RadzenAlert>
    <RadzenTemplateForm TItem="Congregation" Data="@(_congregation)" Visible="@(_congregation != null)"
                        Submit="@HandleValidSubmit">
        <RadzenRow style="margin-bottom: 1rem">
            <RadzenColumn SizeMD="3">
                <RadzenLabel Text="Nombre" Component="Name" style="width: 100%"/>
            </RadzenColumn>
            <RadzenColumn SizeMD="9">
                <RadzenTextBox style="display: block; width: 100%" @bind-Value="@(_congregation.Name)" Name="Name"/>
                <RadzenRequiredValidator Component="Name" Text="El nombre es obligatorio"/>
            </RadzenColumn>
        </RadzenRow>
        <RadzenRow style="margin-bottom: 1rem">
            <RadzenColumn SizeMD="3">
                <RadzenLabel Text="Día Semana Año Par" Component="MidweekMeetingDayEvenYear"
                             style="width: 100%"/>
            </RadzenColumn>
            <RadzenColumn SizeMD="9">
                <RadzenDropDown @bind-Value="@_congregation.MidweekMeetingDayEvenYear" Data="@_daysOfWeek"
                                Style="width: 100%; max-width: 400px;" Name="MidweekMeetingDayEvenYear"/>
            </RadzenColumn>
        </RadzenRow>
        <RadzenRow style="margin-bottom: 1rem">
            <RadzenColumn SizeMD="3">
                <RadzenLabel Text="Día Semana Año Impar" Component="MidweekMeetingDayOddYear"
                             style="width: 100%"/>
            </RadzenColumn>
            <RadzenColumn SizeMD="9">
                <RadzenColumn SizeMD="9">
                    <RadzenDropDown @bind-Value="@_congregation.MidweekMeetingDayOddYear" Data="@_daysOfWeek"
                                    Style="width: 100%; max-width: 400px;" Name="MidweekMeetingDayOddYear"/>
                </RadzenColumn>
            </RadzenColumn>
        </RadzenRow>
        <RadzenRow style="margin-bottom: 1rem">
            <RadzenColumn SizeMD="3">
                <RadzenLabel Text="Día Fin de Semana Año Par" Component="WeekendMeetingDayEvenYear"
                             style="width: 100%"/>
            </RadzenColumn>
            <RadzenColumn SizeMD="9">
                <RadzenDropDown @bind-Value="@_congregation.WeekendMeetingDayEvenYear" Data="@_daysOfWeek"
                                Style="width: 100%; max-width: 400px;" Name="WeekendMeetingDayEvenYear"/>
            </RadzenColumn>
        </RadzenRow>
        <RadzenRow style="margin-bottom: 1rem">
            <RadzenColumn SizeMD="3">
                <RadzenLabel Text="Día Fin de Semana Año Impar" Component="WeekendMeetingDayOddYear"
                             style="width: 100%"/>
            </RadzenColumn>
            <RadzenColumn SizeMD="9">
                <RadzenDropDown @bind-Value="@_congregation.WeekendMeetingDayOddYear" Data="@_daysOfWeek"
                                Style="width: 100%; max-width: 400px;" Name="WeekendMeetingDayOddYear"/>
            </RadzenColumn>
        </RadzenRow>
        <RadzenRow style="margin-bottom: 1rem">
            <RadzenColumn SizeMD="3">
                <RadzenLabel Text="Dirección" Component="Address" style="width: 100%"/>
            </RadzenColumn>
            <RadzenColumn SizeMD="9">
                <RadzenTextBox style="display: block; width: 100%" @bind-Value="@(_congregation.Address)"
                               Name="Address"/>
            </RadzenColumn>
        </RadzenRow>
        <RadzenRow style="margin-bottom: 1rem">
            <RadzenColumn SizeMD="3">
                <RadzenLabel Text="Ciudad" Component="City" style="width: 100%"/>
            </RadzenColumn>
            <RadzenColumn SizeMD="9">
                <RadzenTextBox style="display: block; width: 100%" @bind-Value="@(_congregation.City)" Name="City"/>
            </RadzenColumn>
        </RadzenRow>
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center"
                     JustifyContent="JustifyContent.End" Gap="0.5rem">
            <RadzenButton ButtonStyle="ButtonStyle.Primary" ButtonType="ButtonType.Submit" Icon="save" Text="Guardar"
                          Variant="Variant.Flat"/>
            <RadzenButton ButtonStyle="ButtonStyle.Light" Text="Cancelar" Variant="Variant.Flat"
                          Click="@CancelButtonClick"/>
        </RadzenStack>
    </RadzenTemplateForm>
</RadzenColumn>

@code {
    private readonly Congregation _congregation = new() { Name = string.Empty };
    private bool _errorVisible;
    private readonly List<DayOfWeek> _daysOfWeek = Enum.GetValues(typeof(DayOfWeek)).Cast<DayOfWeek>().ToList();
    
    private async Task HandleValidSubmit()
    {
        try
        {
            await CongregationService.AddAsync(_congregation);
            DialogService.Close(true);
        }
        catch (InvalidOperationException ex)
        {
            // Business rule: only one congregation allowed
            _errorVisible = true;
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Warning, Summary = "Atención", Detail = ex.Message });
        }
        catch
        {
            _errorVisible = true;
        }
    }

    private Task CancelButtonClick(MouseEventArgs args)
    {
        DialogService.Close(null);
        return Task.CompletedTask;
    }
}
