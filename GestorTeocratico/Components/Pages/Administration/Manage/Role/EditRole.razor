@namespace GestorTeocratico.Components.Pages.Administration.Manage.Role
@using Microsoft.AspNetCore.Identity
@using GestorTeocratico.Features.Roles
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using Radzen
@using Radzen.Blazor
@inject DialogService DialogService
@inject IRoleService RoleService

@code {
    [Parameter]
    public string RoleId { get; set; } = string.Empty;

    private RoleViewModel? _role;
    private bool _errorVisible;

    protected override async Task OnInitializedAsync()
    {
        var role = await RoleService.GetByIdAsync(RoleId);
        if (role != null)
        {
            _role = new RoleViewModel { Id = role.Id, Name = role.Name ?? string.Empty };
        }
    }

    private async Task HandleValidSubmit()
    {
        try
        {
            if (_role != null)
            {
                await RoleService.UpdateAsync(_role.Id, _role.Name);
                DialogService.Close(true);
            }
        }
        catch
        {
            _errorVisible = true;
        }
    }

    private void CancelButtonClick(MouseEventArgs args)
    {
        DialogService.Close(null);
    }

    public class RoleViewModel
    {
        public string Id { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
    }
}

@if (_role == null)
{
    <div>Cargando...</div>
}
else
{
    <RadzenColumn SizeMD=12>
        <RadzenAlert Shade="Shade.Lighter" Variant="Variant.Flat" Size="AlertSize.Small" AlertStyle="AlertStyle.Danger"
                     Visible="@_errorVisible">No se puede actualizar el rol
        </RadzenAlert>
        <RadzenTemplateForm TItem="RoleViewModel" Data="@(_role)" Visible="@(_role != null)"
                            Submit="@HandleValidSubmit">
            <RadzenRow style="margin-bottom: 1rem">
                <RadzenColumn SizeMD="3">
                    <RadzenLabel Text="Nombre" Component="Name" style="width: 100%"/>
                </RadzenColumn>
                <RadzenColumn SizeMD="9">
                    <RadzenTextBox style="display: block; width: 100%" @bind-Value="@(_role!.Name)" Name="Name"/>
                    <RadzenRequiredValidator Component="Name" Text="El nombre es obligatorio"/>
                </RadzenColumn>
            </RadzenRow>
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center"
                         JustifyContent="JustifyContent.End" Gap="0.5rem">
                <RadzenButton ButtonStyle="ButtonStyle.Primary" ButtonType="ButtonType.Submit" Icon="save" Text="Guardar"
                              Variant="Variant.Outlined"/>
                <RadzenButton ButtonStyle="ButtonStyle.Light" Text="Cancelar" Variant="Variant.Outlined"
                              Click="@CancelButtonClick"/>
            </RadzenStack>
        </RadzenTemplateForm>
    </RadzenColumn>
}
