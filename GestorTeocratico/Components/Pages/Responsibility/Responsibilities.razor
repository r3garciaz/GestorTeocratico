@page "/responsibilities"
@using GestorTeocratico.Entities
@using GestorTeocratico.Features.Responsibilities
@inject IResponsibilityService ResponsibilityService
@inject DialogService DialogService
@inject NotificationService NotificationService
@attribute [Authorize(Roles = "Admin, Manager")]

<PageTitle>Responsabilidades</PageTitle>
<RadzenStack>
    <RadzenRow AlignItems="AlignItems.Center">
        <RadzenColumn Size="12" SizeMD="6">
            <RadzenText Text="Responsabilidades" TextStyle="TextStyle.H3" TagName="TagName.H1" style="margin: 0"/>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeMD="6">
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center"
                         JustifyContent="JustifyContent.End" Gap="0.5rem">
                <RadzenButton Icon="add_circle_outline" Text="Agregar Responsabilidad" Click="@AddButtonClick" Variant="Variant.Flat"/>
            </RadzenStack>
        </RadzenColumn>
    </RadzenRow>
    <RadzenRow>
        <RadzenColumn SizeMD="12">
            <RadzenDataGrid @ref="grid0" ColumnWidth="200px" AllowFiltering="true" FilterMode="FilterMode.Advanced"
                            AllowPaging="true" AllowSorting="true" ShowPagingSummary="true"
                            PageSizeOptions=@(new int[] { 5, 10, 20, 30 })
                            Data="@(_responsibilities)" >
                <Columns>
                    <RadzenDataGridColumn Property="@nameof(Responsibility.Name)" Title="Nombre"/>
                    <RadzenDataGridColumn Property="@nameof(Responsibility.Description)" Title="Descripción">
                        <Template Context="responsibility">
                            @if (!string.IsNullOrEmpty(responsibility.Description))
                            {
                                <span>@(responsibility.Description.Length > 50 ? $"{responsibility.Description[..50]}..." : responsibility.Description)</span>
                            }
                            else
                            {
                                <span class="text-muted">Sin descripción</span>
                            }
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn Property="@nameof(Responsibility.Department)" Title="Departamento">
                        <Template Context="responsibility">
                            @if (responsibility.Department != null)
                            {
                                <span>@responsibility.Department.Name</span>
                            }
                            else
                            {
                                <span class="text-muted">Sin departamento</span>
                            }
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn Property="@nameof(Responsibility.PublisherResponsibilities)" Title="Publicadores Asignados">
                        <Template Context="responsibility">
                            @if (responsibility.PublisherResponsibilities?.Any() == true)
                            {
                                <span>@string.Join(", ", responsibility.PublisherResponsibilities.Take(2).Select(pr => GetPublisherFullName(pr.Publisher)))</span>
                                @if (responsibility.PublisherResponsibilities.Count > 2)
                                {
                                    <span class="text-muted"> y @(responsibility.PublisherResponsibilities.Count - 2) más...</span>
                                }
                            }
                            else
                            {
                                <span class="text-muted">Sin asignar</span>
                            }
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn Filterable="false" Sortable="false" Width="150px" Title="Acciones"
                                          TextAlign="TextAlign.Center">
                        <Template Context="responsibility">
                            <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat"
                                          Size="ButtonSize.Medium"
                                          Click="@(() => EditRow(responsibility))" @onclick:stopPropagation="true"/>
                            <RadzenButton ButtonStyle="ButtonStyle.Danger" Icon="delete" Size="ButtonSize.Medium"
                                          Shade="Shade.Lighter" Variant="Variant.Flat"
                                          Click="@(args => GridDeleteButtonClick(args, responsibility))"
                                          @onclick:stopPropagation="true"/>
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        </RadzenColumn>
    </RadzenRow>
</RadzenStack>

@code {
    private IEnumerable<Responsibility> _responsibilities = [];
    private RadzenDataGrid<Responsibility> grid0;

    protected override async Task OnInitializedAsync()
    {
        _responsibilities = await ResponsibilityService.GetAllAsync();
    }

    private async Task AddButtonClick(MouseEventArgs args)
    {
        await DialogService.OpenAsync<CreateResponsibility>("Agregar Responsabilidad", null);
        await grid0.Reload();
    }

    private async Task EditRow(Responsibility args)
    {
        await DialogService.OpenAsync<EditResponsibility>("Editar Responsabilidad", new Dictionary<string, object> { { "ResponsibilityId", args.ResponsibilityId } });
        await grid0.Reload();
    }

    private async Task GridDeleteButtonClick(MouseEventArgs args, Responsibility responsibility)
    {
        try
        {
            if (await DialogService.Confirm("¿Está seguro que desea eliminar este registro?", "Confirmar", new ConfirmOptions { OkButtonText = "Eliminar", CancelButtonText = "Cancelar" }) == true)
            {
                var deleteResult = await ResponsibilityService.DeleteAsync(responsibility.ResponsibilityId);
                await grid0.Reload();
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = $"Error",
                Detail = $"No se pudo eliminar la responsabilidad"
            });
        }
    }

    private string GetPublisherFullName(Publisher publisher)
    {
        var fullName = publisher.FirstName;
        if (!string.IsNullOrEmpty(publisher.LastName))
            fullName += $" {publisher.LastName}";
        if (!string.IsNullOrEmpty(publisher.MotherLastName))
            fullName += $" {publisher.MotherLastName}";
        return fullName;
    }
}
