@page "/meeting-schedules"

@using GestorTeocratico.Entities
@using GestorTeocratico.Features.MeetingSchedules
@using GestorTeocratico.Features.Responsibilities
@using GestorTeocratico.Features.PdfExport
@using GestorTeocratico.Shared.Enums
@using System.Globalization

@inject NavigationManager NavigationManager
@inject IMeetingScheduleService MeetingScheduleService
@inject IResponsibilityService ResponsibilityService
@inject IPdfExportService PdfExportService
@inject DialogService DialogService
@inject NotificationService NotificationService

<PageTitle>Programación de Responsabilidades</PageTitle>

<RadzenStack>
    <RadzenRow AlignItems="AlignItems.Center">
        <RadzenColumn Size="12" SizeMD="6">
            <RadzenText Text="Programación de Responsabilidades" TextStyle="TextStyle.H3" TagName="TagName.H1" style="margin: 0"/>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeMD="6">
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.End" Gap="0.5rem">
                <RadzenDropDown @bind-Value="@_selectedViewType" Data="@_viewTypes" TextProperty="Text" ValueProperty="Value" 
                               Change="@(args => OnViewTypeChanged())" Style="width: 150px;"/>
                @if (_selectedViewType == "month" && _meetingSchedules?.Any() == true)
                {
                    <RadzenButton Icon="picture_as_pdf" Text="Exportar PDF" Click="@ExportToPdf" ButtonStyle="ButtonStyle.Info" Variant="Variant.Flat" Disabled="@_exportingPdf"/>
                }
                <RadzenButton Icon="content_copy" Text="Copiar Semana" Click="@ShowCopyWeekDialog" ButtonStyle="ButtonStyle.Secondary" Variant="Variant.Flat"/>
                <RadzenButton Icon="refresh" Text="Actualizar" Click="@LoadDataAsync" ButtonStyle="ButtonStyle.Primary" Variant="Variant.Flat"/>
            </RadzenStack>
        </RadzenColumn>
    </RadzenRow>

    @if (_selectedViewType == "week")
    {
        <RadzenRow AlignItems="AlignItems.Center" style="margin-bottom: 1rem;">
            <RadzenColumn Size="12" SizeMD="4">
                <RadzenLabel Text="Año:" />
                <RadzenNumeric @bind-Value="@_selectedYear" Min="2020" Max="2030" Change="@((int args) => LoadDataAsync())" Style="width: 100px;"/>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeMD="4">
                <RadzenLabel Text="Semana:" />
                <RadzenNumeric @bind-Value="@_selectedWeek" Min="1" Max="53" Change="@((int args) => LoadDataAsync())" Style="width: 100px;"/>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeMD="4">
                <RadzenText Text="@GetWeekDateRange()" TextStyle="TextStyle.Body1" style="font-weight: 500;"/>
            </RadzenColumn>
        </RadzenRow>
    }
    else if (_selectedViewType == "month")
    {
        <RadzenRow AlignItems="AlignItems.Center" style="margin-bottom: 1rem;">
            <RadzenColumn Size="12" SizeMD="3">
                <RadzenLabel Text="Año:" />
                <RadzenNumeric @bind-Value="@_selectedYear" Min="2020" Max="2030" Change="@((int args) => LoadDataAsync())" Style="width: 100px;"/>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeMD="3">
                <RadzenLabel Text="Mes:" />
                <RadzenNumeric @bind-Value="@_selectedMonth" Min="1" Max="12" Change="@((int args) => LoadDataAsync())" Style="width: 100px;"/>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeMD="6">
                <RadzenText Text="@GetMonthName()" TextStyle="TextStyle.Body1" style="font-weight: 500;"/>
            </RadzenColumn>
        </RadzenRow>
    }

    @if (_meetingSchedules?.Any() == true)
    {
        <RadzenCard>
            <RadzenDataGrid @ref="@_grid" Data="@_weeklySchedules" TItem="WeeklyScheduleDto" AllowFiltering="false" AllowPaging="false" 
                           AllowSorting="false" AllowColumnResize="true">
                
                <Columns>
                    <RadzenDataGridColumn TItem="WeeklyScheduleDto" Property="WeekDisplay" Title="Semana" Width="100px" Frozen="true">
                        <Template Context="week">
                            <div style="text-align: center; font-weight: bold;">
                                <div>Sem @week.WeekOfYear</div>
                                <div style="font-size: 0.8em; color: #666;">@week.DateRange</div>
                            </div>
                        </Template>
                    </RadzenDataGridColumn>
                    
                    <RadzenDataGridColumn TItem="WeeklyScheduleDto" Property="MeetingType" Title="Reunión" Width="80px" Frozen="true">
                        <Template Context="week">
                            <RadzenBadge Text="@(week.MeetingType == MeetingType.Midweek ? "Midweek" : "Weekend")" 
                                       BadgeStyle="@(week.MeetingType == MeetingType.Midweek ? BadgeStyle.Primary : BadgeStyle.Success)" />
                        </Template>
                    </RadzenDataGridColumn>

                    @foreach (var responsibility in _responsibilities)
                    {
                        <RadzenDataGridColumn TItem="WeeklyScheduleDto" Property="@responsibility.ResponsibilityId.ToString()" 
                                            Title="@responsibility.Name" Width="150px">
                            <Template Context="week">
                                @{
                                    var assignment = week.Assignments.FirstOrDefault(a => a.ResponsibilityId == responsibility.ResponsibilityId);
                                }
                                <div style="min-height: 40px; cursor: pointer;" @onclick="@(() => ShowAssignmentDialog(week, responsibility))">
                                    @if (assignment?.Publisher != null)
                                    {
                                        <RadzenBadge Text="@GetPublisherFullName(assignment.Publisher)" 
                                                   BadgeStyle="BadgeStyle.Light" 
                                                   Style="margin: 2px; font-size: 0.75em; width: 100%; text-align: center;"/>
                                    }
                                    else
                                    {
                                        <div style="color: #ccc; text-align: center; padding: 8px;">
                                            <RadzenIcon Icon="add" Style="font-size: 16px;"/>
                                            <div style="font-size: 0.7em; margin-top: 2px;">Asignar</div>
                                        </div>
                                    }
                                </div>
                            </Template>
                        </RadzenDataGridColumn>
                    }
                </Columns>
            </RadzenDataGrid>
        </RadzenCard>
    }
    else
    {
        <RadzenCard>
            <div style="text-align: center; padding: 40px;">
                <RadzenIcon Icon="event_note" Style="font-size: 48px; color: #ccc; margin-bottom: 16px;"/>
                <RadzenText Text="No hay horarios disponibles para el período seleccionado" TextStyle="TextStyle.Body1"/>
                <RadzenButton Text="Crear Horarios" Icon="add" Click="@CreateSchedulesForPeriod" ButtonStyle="ButtonStyle.Primary" 
                             Variant="Variant.Flat" Style="margin-top: 16px;"/>
            </div>
        </RadzenCard>
    }
</RadzenStack>

@code {
    private RadzenDataGrid<WeeklyScheduleDto> _grid = new();
    private IEnumerable<MeetingSchedule> _meetingSchedules = [];
    private IEnumerable<Responsibility> _responsibilities = [];
    private List<WeeklyScheduleDto> _weeklySchedules = [];
    private bool _exportingPdf;
    
    private string _selectedViewType = "month";
    private int _selectedYear = DateTime.Now.Year;
    private int _selectedMonth = DateTime.Now.Month;
    private int _selectedWeek = ISOWeek.GetWeekOfYear(DateTime.Now);
    
    private readonly List<ViewTypeOption> _viewTypes =
    [
        new() { Text = "Por Semana", Value = "week" },
        new() { Text = "Por Mes", Value = "month" },
        new() { Text = "Lista Completa", Value = "list" }
    ];

    protected override async Task OnInitializedAsync()
    {
        await LoadResponsibilitiesAsync();
        await LoadDataAsync();
    }

    private async Task LoadResponsibilitiesAsync()
    {
        _responsibilities = await ResponsibilityService.GetAllAsync();
    }

    private async Task LoadDataAsync()
    {
        try
        {
            switch (_selectedViewType)
            {
                case "week":
                    await LoadWeekData();
                    break;
                case "month":
                    await LoadMonthData();
                    break;
                default:
                    await LoadAllData();
                    break;
            }
            
            ProcessSchedulesForDisplay();
        }
        catch
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Error al cargar los datos");
        }
    }

    private async Task LoadWeekData()
    {
        _meetingSchedules = await MeetingScheduleService.GetOrCreateWeekSchedulesAsync(_selectedWeek, _selectedYear);
    }

    private async Task LoadMonthData()
    {
        var monthSchedules = new List<MeetingSchedule>();
        
        // Get all weeks in the selected month
        var firstDayOfMonth = new DateTime(_selectedYear, _selectedMonth, 1);
        var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);
        
        var startWeek = ISOWeek.GetWeekOfYear(firstDayOfMonth);
        var endWeek = ISOWeek.GetWeekOfYear(lastDayOfMonth);
        
        // Handle year boundary (December to January)
        var currentYear = _selectedYear;
        
        // If we're in January and the first week belongs to previous year
        if (_selectedMonth == 1 && startWeek > 50)
        {
            startWeek = 1;
        }
        // If we're in December and the last week belongs to next year  
        else if (_selectedMonth == 12 && endWeek < 10)
        {
            endWeek = ISOWeek.GetWeeksInYear(_selectedYear);
        }
        
        // Create or get schedules for each week in the month
        for (int week = startWeek; week <= endWeek; week++)
        {
            try
            {
                var weekSchedules = await MeetingScheduleService.GetOrCreateWeekSchedulesAsync(week, currentYear);
                
                // Filter schedules that actually belong to the selected month
                var monthlySchedules = weekSchedules.Where(ws => ws.Month == _selectedMonth && ws.Year == _selectedYear);
                monthSchedules.AddRange(monthlySchedules);
            }
            catch (Exception)
            {
                // Continue to next week if there's an error with this week
                continue;
            }
        }
        
        _meetingSchedules = monthSchedules.OrderBy(ms => ms.Date).ToList();
    }

    private async Task LoadAllData()
    {
        _meetingSchedules = await MeetingScheduleService.GetAllAsync();
    }

    private void ProcessSchedulesForDisplay()
    {
        _weeklySchedules = _meetingSchedules
            .OrderBy(ms => ms.WeekOfYear)
            .ThenBy(ms => ms.MeetingType)
            .Select(ms => new WeeklyScheduleDto
            {
                MeetingScheduleId = ms.MeetingScheduleId,
                WeekOfYear = ms.WeekOfYear,
                Year = ms.Year,
                MeetingType = ms.MeetingType,
                DateRange = GetWeekDateRange(ms.WeekOfYear, ms.Year),
                WeekDisplay = $"Semana {ms.WeekOfYear}",
                Assignments = ms.ResponsibilityAssignments.ToList()
            })
            .ToList();
    }

    private async Task OnViewTypeChanged()
    {
        await LoadDataAsync();
        StateHasChanged();
    }

    private string GetWeekDateRange()
    {
        return GetWeekDateRange(_selectedWeek, _selectedYear);
    }

    private string GetWeekDateRange(int week, int year)
    {
        var monday = ISOWeek.ToDateTime(year, week, DayOfWeek.Monday);
        var sunday = monday.AddDays(6);
        return $"{monday:dd/MM} - {sunday:dd/MM/yyyy}";
    }

    private string GetMonthName()
    {
        var culture = new CultureInfo("es-ES");
        var monthName = culture.DateTimeFormat.GetMonthName(_selectedMonth);
        return $"{monthName} {_selectedYear}";
    }

    private string GetPublisherFullName(Publisher publisher)
    {
        var fullName = publisher.FirstName;
        if (!string.IsNullOrEmpty(publisher.LastName))
            fullName += $" {publisher.LastName}";
        return fullName;
    }

    private async Task ShowAssignmentDialog(WeeklyScheduleDto week, Responsibility responsibility)
    {
        var parameters = new Dictionary<string, object>
        {
            { "MeetingScheduleId", week.MeetingScheduleId },
            { "ResponsibilityId", responsibility.ResponsibilityId },
            { "WeekOfYear", week.WeekOfYear },
            { "Year", week.Year },
            { "MeetingType", week.MeetingType },
            { "ResponsibilityName", responsibility.Name }
        };

        await DialogService.OpenAsync<AssignResponsibilityModal>("Asignar Responsabilidad", parameters);
        await LoadDataAsync();
    }

    private async Task ShowCopyWeekDialog()
    {
        var result = await DialogService.OpenAsync<CopyWeekModal>("Copiar Asignaciones de Semana");
        if (result != null)
        {
            await LoadDataAsync();
            NotificationService.Notify(NotificationSeverity.Success, "Éxito", "Asignaciones copiadas correctamente");
        }
    }

    private async Task CreateSchedulesForPeriod()
    {
        try
        {
            switch (_selectedViewType)
            {
                case "week":
                    await MeetingScheduleService.GetOrCreateWeekSchedulesAsync(_selectedWeek, _selectedYear);
                    break;
                case "month":
                    // Create schedules for all weeks in the month
                    var firstDayOfMonth = new DateTime(_selectedYear, _selectedMonth, 1);
                    var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);
                    
                    var firstWeek = ISOWeek.GetWeekOfYear(firstDayOfMonth);
                    var lastWeek = ISOWeek.GetWeekOfYear(lastDayOfMonth);
                    
                    for (int week = firstWeek; week <= lastWeek; week++)
                    {
                        await MeetingScheduleService.GetOrCreateWeekSchedulesAsync(week, _selectedYear);
                    }
                    break;
            }
            
            await LoadDataAsync();
            NotificationService.Notify(NotificationSeverity.Success, "Éxito", "Horarios creados correctamente");
        }
        catch
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Error al crear los horarios");
        }
    }

    private void ShowInCompanion()
    {
        NotificationService.Notify(NotificationSeverity.Info, "Companion", $"{_selectedMonth}{_selectedYear}");
        PdfExportService.ShowInCompanionAsync(_selectedMonth, _selectedYear);
    }

    private void ExportToPdf()
    {
        try
        {
            _exportingPdf = true;
            StateHasChanged();
            
            // Navegar directamente al endpoint para descargar el PDF
            var url = $"/api/meeting-schedules/monthly-schedule/{_selectedYear}/{_selectedMonth}";
            NavigationManager.NavigateTo(url, forceLoad: true);

            NotificationService.Notify(NotificationSeverity.Success, "Éxito", "PDF generado correctamente");
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Error al generar PDF: {ex.Message}");
        }
        finally
        {
            _exportingPdf = false;
            StateHasChanged();
        }
    }

    public class WeeklyScheduleDto
    {
        public Guid MeetingScheduleId { get; set; }
        public int WeekOfYear { get; set; }
        public int Year { get; set; }
        public MeetingType MeetingType { get; set; }
        public string DateRange { get; set; } = string.Empty;
        public string WeekDisplay { get; set; } = string.Empty;
        public List<ResponsibilityAssignment> Assignments { get; set; } = [];
    }

    private class ViewTypeOption
    {
        public string Text { get; set; } = string.Empty;
        public string Value { get; set; } = string.Empty;
    }
}
